<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Process data • scanstatistics</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../jquery.sticky-kit.min.js"></script><script src="../../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../index.html">scanstatistics</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/make_data.html">Process data</a>
    </li>
    <li>
      <a href="../../articles/introduction.html">Introduction to scanstatistics</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/BenjaK/scanstatistics">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Process data</h1>
                        <h4 class="author">Benjamin Allévius</h4>
            
            <h4 class="date">2017-08-01</h4>
          </div>

    
    
<div class="contents">
<div id="process-the-brain-cancer-data" class="section level2">
<h2 class="hasAnchor">
<a href="#process-the-brain-cancer-data" class="anchor"></a>Process the brain cancer data</h2>
<p>This file shows how to reshape the New Mexico brain cancer data from the R package <em>rsatscan</em> <span class="citation">(Kleinman 2015)</span> to a format suitable for the <em>scanstatistics</em> package.</p>
<p>We begin by loading the needed packages and the data, which comes as these three data frames:</p>
<ul>
<li>
<code>NM_cas</code>: contains the number of cancer cases per year, county, age group, and sex. Two counties are missing from this data frame:
<ul>
<li>Cibola: this county was split from Valencia in 1981, so cases in Cibola have been counted to Valencia in the data. Cibola is not present in the data frames below either.</li>
<li>Harding: this county is present in the two other data frames. We will replace the case values in Harding with 0, which is the assumed number of cases since this county has such a small population.</li>
</ul>
</li>
<li>
<code>NM_pop</code>: with the exception of Cibola county, this data frame contains the population count for all counties, age groups, and gender category in the years 1973, 1982, and 1991.</li>
<li>
<code>NM_geo</code>: contains the longitude and latitude of each county’s seat (administrative center). Since the coordinates provided by the <code>rsatscan</code> package is not in the needed format, we will grab the coordinates from <a href="https://en.wikipedia.org/wiki/List_of_counties_in_New_Mexico">this Wikipedia article</a> instead, and replace this data frame.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rsatscan)</code></pre></div>
<pre><code>## rsatscan only does anything useful if you have SaTScan</code></pre>
<pre><code>## See http://www.satscan.org/ for free access</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(data.table)

NM_pop &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/as.data.table">as.data.table</a></span>(NMpop)
NM_cas &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/as.data.table">as.data.table</a></span>(NMcas)</code></pre></div>
<p>To get more familiar with the counties of New Mexico, let’s plot them on a map:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)

<span class="co"># Grab polygon data for plotting</span>
NM_map &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/as.data.table">as.data.table</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/map_data">map_data</a></span>(<span class="st">"county"</span>, <span class="st">"new mexico"</span>))

<span class="co"># Calculate geographical centroids from the polygons in NM_map</span>
<span class="co"># See: https://en.wikipedia.org/wiki/Centroid#Centroid_of_polygon</span>
polygon_centroid &lt;-<span class="st"> </span>function(x0, y0) {
  x1 &lt;-<span class="st"> </span><span class="kw">c</span>(x0[-<span class="dv">1</span>], x0[<span class="dv">1</span>])
  y1 &lt;-<span class="st"> </span><span class="kw">c</span>(y0[-<span class="dv">1</span>], y0[<span class="dv">1</span>])
  A &lt;-<span class="st"> </span><span class="kw">sum</span>(x0 *<span class="st"> </span>y1 -<span class="st"> </span>x1 *<span class="st"> </span>y0) /<span class="st"> </span><span class="dv">2</span>
  Cx &lt;-<span class="st"> </span><span class="kw">sum</span>((x0 +<span class="st"> </span>x1) *<span class="st"> </span>(x0 *<span class="st"> </span>y1 -<span class="st"> </span>x1 *<span class="st"> </span>y0)) /<span class="st"> </span>(<span class="dv">6</span> *<span class="st"> </span>A)
  Cy &lt;-<span class="st"> </span><span class="kw">sum</span>((y0 +<span class="st"> </span>y1) *<span class="st"> </span>(x0 *<span class="st"> </span>y1 -<span class="st"> </span>x1 *<span class="st"> </span>y0)) /<span class="st"> </span>(<span class="dv">6</span> *<span class="st"> </span>A)
  <span class="kw">data.frame</span>(<span class="dt">long =</span> Cx, <span class="dt">lat =</span> Cy)
}

<span class="co"># Calculate geographic centroids for each county</span>
centroids &lt;-<span class="st"> </span>NM_map[, <span class="kw">polygon_centroid</span>(long, lat), by =<span class="st"> </span>.(subregion)]

<span class="co"># Plot map with labels at centroids</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>() +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_polygon">geom_polygon</a></span>(<span class="dt">data =</span> NM_map,
               <span class="dt">mapping =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group),
               <span class="dt">color =</span> <span class="st">"white"</span>, <span class="dt">fill =</span> <span class="st">"grey"</span>) +
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_text">geom_text</a></span>(<span class="dt">data =</span> centroids, 
            <span class="dt">mapping =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">label =</span> subregion)) +
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ggtitle</a></span>(<span class="st">"Counties of New Mexico"</span>) +
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</code></pre></div>
<p><img src="make_data_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>Before proceeding, we will make some changes to the data to ensure that the counties are named the same across all tables. The main functions of the scanstatistic package require locations to be encoded as integers. Thus we will make the county names into a factor variable, which are integer vectors with additional attributes. All levels of the factor should also be present in the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(magrittr)
<span class="kw">library</span>(stringr)
<span class="kw">library</span>(plyr, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)
<span class="kw">library</span>(dplyr)</code></pre></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:plyr':
## 
##     arrange, count, desc, failwith, id, mutate, rename, summarise,
##     summarize</code></pre>
<pre><code>## The following objects are masked from 'package:data.table':
## 
##     between, first, last</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># This function corrects inconsistencies in the county names</span>
format_counties &lt;-<span class="st"> </span>function(x) {
  x %&gt;%
<span class="st">    </span>tolower %&gt;%
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/stringr/topics/str_replace">str_replace_all</a></span>(<span class="dt">pattern =</span> <span class="st">" "</span>, <span class="dt">replacement =</span> <span class="st">""</span>) %&gt;%
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/stringr/topics/str_replace">str_replace_all</a></span>(<span class="dt">pattern =</span> <span class="st">"ñ"</span>, <span class="dt">replacement =</span> <span class="st">"n"</span>) %&gt;%
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/stringr/topics/str_replace">str_replace_all</a></span>(<span class="dt">pattern =</span> <span class="st">"guadelupe"</span>, <span class="dt">replacement =</span> <span class="st">"guadalupe"</span>)
}

<span class="co"># Make the county factor variable</span>
all_counties &lt;-<span class="st"> </span>NM_map$subregion %&gt;%
<span class="st">  </span>unique %&gt;%
<span class="st">  </span>format_counties %&gt;%
<span class="st">  </span>as.factor

<span class="co"># Character vector without Cibola county</span>
counties &lt;-<span class="st"> </span><span class="kw">levels</span>(all_counties)[-<span class="kw">which</span>(<span class="kw">levels</span>(all_counties) ==<span class="st"> "cibola"</span>)]

<span class="co"># This function corrects inconsistencies in x and makes it into a factor</span>
factorize_counties &lt;-<span class="st"> </span>function(x, <span class="dt">fac =</span> counties) {
  x %&gt;%
<span class="st">    </span>format_counties %&gt;%
<span class="st">    </span><span class="kw">factor</span>(<span class="dt">levels =</span> <span class="kw">c</span>(fac, <span class="st">"cibola"</span>))
}

<span class="co"># Fix inconsistencies and factorize counties in the data</span>
centroids %&lt;&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/mutate">mutate</a></span>(<span class="dt">county =</span> <span class="kw">format_counties</span>(subregion),
         <span class="dt">county =</span> <span class="kw">factorize_counties</span>(county),
         <span class="dt">center_long =</span> long, <span class="dt">center_lat =</span> lat,
         <span class="dt">long =</span> <span class="ot">NULL</span>, <span class="dt">lat =</span> <span class="ot">NULL</span>,
         <span class="dt">subregion =</span> <span class="ot">NULL</span>)
NM_cas %&lt;&gt;%<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/mutate">mutate</a></span>(<span class="dt">county =</span> <span class="kw">factorize_counties</span>(county)) %&gt;%<span class="st"> </span>as.data.table
NM_pop %&lt;&gt;%<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/mutate">mutate</a></span>(<span class="dt">county =</span> <span class="kw">factorize_counties</span>(county))
NM_map %&lt;&gt;%<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/mutate">mutate</a></span>(<span class="dt">county =</span> <span class="kw">factorize_counties</span>(subregion)) %&gt;%<span class="st"> </span>as.data.table
NM_pop %&lt;&gt;%<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/plyr/topics/mutate">mutate</a></span>(<span class="dt">year =</span> year +<span class="st"> </span><span class="dv">1900</span>) %&gt;%<span class="st"> </span>as.data.table</code></pre></div>
<p>Scan statistics aim to find <em>localized</em> anomalies in the data, meaning that the locations and timepoints involved in the anomaly are close together in some way. In this example, we will measure the spatial similarity using the spherical distance between the county seats. In other circumstances, we might use the geographic centroids (calculated above), or another distance measure. So let’s grab the coordinates of the county seats from Wikipedia and plot them. Kudos to Cory Nissen for <a href="http://blog.corynissen.com/2015/01/using-rvest-to-scrape-html-table.html">this blogpost</a>, which shows how to fetch data from a table on Wikipedia.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rvest)</code></pre></div>
<pre><code>## Loading required package: xml2</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)

<span class="co"># Function to clean table entries</span>
clean_entry &lt;-<span class="st"> </span>function(x) {
  x %&gt;%
<span class="st">    </span><span class="kw">gsub</span>(<span class="st">"</span><span class="ch">\\</span><span class="st">d+♠"</span>, <span class="st">""</span>,  .) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">gsub</span>(<span class="st">"^[^</span><span class="ch">\\</span><span class="st">(]+</span><span class="ch">\\</span><span class="st">("</span>, <span class="st">""</span>, .) %&gt;%
<span class="st">    </span><span class="kw">gsub</span>(<span class="st">"</span><span class="ch">\\</span><span class="st">,"</span>, <span class="st">""</span>, .) %&gt;%
<span class="st">    </span><span class="kw"><a href="http://www.rdocumentation.org/packages/stringr/topics/str_split">str_split</a></span>(<span class="dt">pattern =</span> <span class="st">"[:blank:]"</span>) %&gt;%
<span class="st">    </span><span class="kw">lapply</span>(function(x) x[<span class="dv">1</span>]) %&gt;%
<span class="st">    </span>unlist %&gt;%
<span class="st">    </span>as.numeric
    <span class="co"># gsub("\\ [:alpha:]+", "", .)</span>
    <span class="co"># gsub("\ km2\\)", "", .) %&gt;%</span>
    <span class="co"># gsub("\ km²\\)", "", .)</span>
}

<span class="co"># Grab the table from Wikipedia (as at 2017-08-01)</span>
seat_url &lt;-<span class="st"> "https://en.wikipedia.org/wiki/List_of_counties_in_New_Mexico"</span>
NM_geo &lt;-<span class="st"> </span>seat_url %&gt;%
<span class="st">  </span>read_html %&gt;%
<span class="st">  </span>rvest::<span class="kw"><a href="http://www.rdocumentation.org/packages/rvest/topics/html_nodes">html_nodes</a></span>(<span class="dt">xpath =</span> <span class="st">'//*[@id="mw-content-text"]/div/table[3]'</span>) %&gt;%
<span class="st">  </span>html_table %&gt;%
<span class="st">  </span>.[[<span class="dv">1</span>]] %&gt;%
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(County, <span class="st">`</span><span class="dt">County seat[3]</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Population[6]</span><span class="st">`</span>, <span class="st">`</span><span class="dt">Area[3][7]</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">county =</span> County, 
         <span class="dt">seat =</span> <span class="st">`</span><span class="dt">County seat[3]</span><span class="st">`</span>, 
         <span class="dt">population =</span> <span class="st">`</span><span class="dt">Population[6]</span><span class="st">`</span>, 
         <span class="st">`</span><span class="dt">area(km2)</span><span class="st">`</span> =<span class="st"> `</span><span class="dt">Area[3][7]</span><span class="st">`</span>) %&gt;%
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise_all.html">mutate_at</a></span>(<span class="dt">.vars =</span> <span class="kw">c</span>(<span class="st">"population"</span>, <span class="st">"area(km2)"</span>), <span class="dt">.funs =</span> clean_entry) %&gt;%
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">county =</span> <span class="kw">gsub</span>(<span class="st">" County"</span>, <span class="st">""</span>, county)) %&gt;%
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">county =</span> <span class="kw">factorize_counties</span>(county, counties)) %&gt;%
<span class="st">  </span>as.data.table


<span class="co"># Get the coordinates for the New Mexico county seats using ggmap::geocode</span>
get_NM_longlat &lt;-<span class="st"> </span>function(seats) {
  <span class="kw">suppressMessages</span>({
    res &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">sapply</span>(seats, function(x) <span class="kw">t</span>(ggmap::<span class="kw">geocode</span>(<span class="kw">paste0</span>(x, <span class="st">", New Mexico"</span>)))))
  })
  <span class="kw">data.frame</span>(<span class="dt">seat_long =</span> res[, <span class="dv">1</span>], <span class="dt">seat_lat =</span> res[, <span class="dv">2</span>])
}

NM_geo &lt;-<span class="st"> </span><span class="kw">cbind</span>(NM_geo, <span class="kw">get_NM_longlat</span>(NM_geo$seat))
NM_geo &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/merge">merge</a></span>(NM_geo, centroids, <span class="dt">by =</span> <span class="st">"county"</span>)

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>() +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_polygon">geom_polygon</a></span>(<span class="dt">data =</span> NM_map,
               <span class="dt">mapping =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group),
               <span class="dt">color =</span> <span class="st">"white"</span>, <span class="dt">fill =</span> <span class="st">"grey"</span>) +
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="dt">data =</span> NM_geo, 
             <span class="dt">mapping =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> seat_long, <span class="dt">y =</span> seat_lat)) +
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ggtitle</a></span>(<span class="st">"County seats of New Mexico"</span>) +
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggtheme">theme_bw</a></span>()</code></pre></div>
<p><img src="make_data_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>For the scan statistic functions in this package to work, locations and timepoints with zero counts must be filled in as such, and not left out. Thus, we will add the needed zeros to the case data. We will only consider the total number of cancer cases in each county and year, so we also take the oppotunity to aggregate the case counts over each age group and sex:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Aggregate population and cases over sex and age group</span>
NM_cas &lt;-<span class="st"> </span>NM_cas[, .(<span class="dt">count =</span> <span class="kw">sum</span>(cases)), by =<span class="st"> </span>.(year, county)]
NM_pop &lt;-<span class="st"> </span>NM_pop[, .(<span class="dt">population =</span> <span class="kw">sum</span>(population)), by =<span class="st"> </span>.(year, county)]

<span class="co"># Create the complete, sorted table of counties, years, age groups, and sex</span>
combo_YC &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/as.data.table">as.data.table</a></span>(<span class="kw">expand.grid</span>(<span class="dt">year =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/duplicated">unique</a></span>(NM_cas$year), 
                                      <span class="dt">county =</span> counties))

<span class="co"># Set keys for merge</span>
<span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/setkey">setkeyv</a></span>(NM_cas, <span class="kw">c</span>(<span class="st">"year"</span>, <span class="st">"county"</span>))
<span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/setkey">setkeyv</a></span>(NM_pop, <span class="kw">c</span>(<span class="st">"year"</span>, <span class="st">"county"</span>))
<span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/setkey">setkeyv</a></span>(combo_YC, <span class="kw">c</span>(<span class="st">"year"</span>, <span class="st">"county"</span>))

<span class="co"># Merge data</span>
NM_cas &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/merge">merge</a></span>(NM_cas, combo_YC, <span class="dt">all =</span> <span class="ot">TRUE</span>)
NM_pop &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/merge">merge</a></span>(NM_pop, combo_YC, <span class="dt">all =</span> <span class="ot">TRUE</span>)

<span class="co"># Fill in zero case counts</span>
NM_cas[<span class="kw">is.na</span>(count), count :<span class="er">=</span><span class="st"> </span><span class="dv">0</span>]</code></pre></div>
<p>To demonstrate the scan statistic methods of this package, we will try to detect brain cancer clusters in the years 1986–1989, using data from the previous years to predict how many cancer cases we can expect to see if there is no anomalous increase in incidence. In this particular example, we want to use the available population size data as offsets to our predicted means, in order to properly compare the occurence of cancer in the different counties. Since the population counts are only available for three of the years, we will interpolate the population for the remaining years by fitting a quadratic function of time to the population data for each county after aggregating the number of cancer cases over age group and gender<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>. Though this leads to unrealistically smooth population changes, it is adequate for the purpose of demonstrating the functions in the <em>scanstatistics</em> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">NM_pop[, population :<span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(population)]

<span class="co"># Interpolate county populations</span>
for (s in counties) {
  pop_mod &lt;-<span class="st"> </span><span class="kw">lm</span>(population ~<span class="st"> </span><span class="dv">1</span> +<span class="st"> </span><span class="kw">I</span>(<span class="kw">scale</span>(year)) +<span class="st"> </span><span class="kw">I</span>(<span class="kw">scale</span>(year)^<span class="dv">2</span>), 
                <span class="dt">data =</span> NM_pop[county ==<span class="st"> </span>s, ])
  pop_pred &lt;-<span class="st"> </span><span class="kw">predict</span>(pop_mod, NM_pop[<span class="kw">is.na</span>(population) &amp;<span class="st"> </span>county ==<span class="st"> </span>s, ], 
                      <span class="dt">type =</span> <span class="st">"response"</span>)
  NM_pop[<span class="kw">is.na</span>(population) &amp;<span class="st"> </span>county ==<span class="st"> </span>s, population :<span class="er">=</span><span class="st"> </span>pop_pred]
}</code></pre></div>
<p>Finally, we join the population and case tables and plot how the number of cases evolve in each county over the years:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">NM_popcas &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/merge">merge</a></span>(NM_pop, NM_cas)
<span class="kw"><a href="http://www.rdocumentation.org/packages/data.table/topics/setkey">setkeyv</a></span>(NM_popcas, <span class="kw">c</span>(<span class="st">"county"</span>, <span class="st">"year"</span>))

<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(NM_popcas) +<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x =</span> year, <span class="dt">y =</span> count, <span class="dt">color =</span> county)) +
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(<span class="dt">legend.position =</span> <span class="st">"none"</span>)</code></pre></div>
<p><img src="make_data_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<p>The data tables <code>NM_popcas</code>, <code>NM_geo</code> and <code>NM_map</code> are then saved as those available in the <em>scanstatistics</em> package, after converting them to data frames:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">NM_popcas %&lt;&gt;%<span class="st"> </span>as.data.frame
NM_geo %&lt;&gt;%<span class="st"> </span>as.data.frame
NM_map %&lt;&gt;%<span class="st"> </span>as.data.frame</code></pre></div>
<div id="refs" class="references">
<div id="ref-rsatscan">
<p>Kleinman, Ken. 2015. <em>Rsatscan: Tools, Classes, and Methods for Interfacing with Satscan Stand-Alone Software</em>. <a href="https://CRAN.R-project.org/package=rsatscan" class="uri">https://CRAN.R-project.org/package=rsatscan</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>One could also fit the quadratic function for each county, age group and sex, and then aggregate over the latter two categories in the hope that this would cancel out the errors made in each interpolation. However, this seems to lead to some unreasonable year-to-year population changes for some of the counties.<a href="#fnref1">↩</a></p></li>
</ol>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#process-the-brain-cancer-data">Process the brain cancer data</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Benjamin Allévius.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
