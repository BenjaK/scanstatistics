<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Process data &bull; scanstatistics</title><!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous"><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet"><script src="../../jquery.sticky-kit.min.js"></script><script src="../../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../index.html">scanstatistics</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li>
  <a href="../../articles/index.html">Articles</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/BenjaK/scanstatistics">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Process data</h1>
                        <h4 class="author">Benjamin Kjellson</h4>
            
            <h4 class="date">2016-11-16</h4>
          </div>

    
    
<div class="contents">
<div id="process-the-brain-cancer-data" class="section level2">
<h2 class="hasAnchor"><html><body><a href="#process-the-brain-cancer-data" class="anchor"> </a></body></html>Process the brain cancer data</h2>
<p>This file shows how to reshape the New Mexico brain cancer data from the R package <em>rsatscan</em> <span class="citation">(Kleinman 2015)</span> to a format suitable for the <em>scanstatistics</em> package.</p>
<p>We begin by loading the needed packages and the data, which comes as these three data frames:</p>
<ul><li><code>NM_cas</code>: contains the number of cancer cases per year, county, age group, and sex. Two counties are missing from this data frame:
<ul><li>Cibola: this county was split from Valencia in 1981, so cases in Cibola have been counted to Valencia in the data. Cibola is not present in the data frames below either.</li>
<li>Harding: this county is present in the two other data frames. We will replace the case values in Harding with 0, which is the assumed number of cases since this county has such a small population.</li>
</ul></li>
<li><code>NM_pop</code>: with the exception of Cibola county, this data frame contains the population count for all counties, age groups, and gender category in the years 1973, 1982, and 1991.</li>
<li><code>NM_geo</code>: contains the longitude and latitude of each county&rsquo;s seat (administrative center). Since the coordinates provided by the <code>rsatscan</code> package is not in the needed format, we will grab the coordinates from <a href="https://en.wikipedia.org/wiki/List_of_counties_in_New_Mexico">this Wikipedia article</a> instead, and replace this data frame.</li>
</ul><p>The <code>scanstatistics</code> package relies heavily on the <em>data.table</em> <span class="citation">(Dowle et al. 2015)</span> package for its calculations, and the main argument to all <code>scan_</code> functions will be data tables. Therefore, we convert the data frames to data tables straight away as we load it:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rsatscan)
<span class="kw">library</span>(data.table)

NM_pop &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(NMpop)
NM_cas &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(NMcas)</code></pre></div>
<p>To get more familiar with the counties of New Mexico, let&rsquo;s plot them on a map:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)

<span class="co"># Grab polygon data for plotting</span>
NM_map &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">map_data</span>(<span class="st">"county"</span>, <span class="st">"new mexico"</span>))

<span class="co"># Calculate geographical centroids from the polygons in NM_map</span>
<span class="co"># See: https://en.wikipedia.org/wiki/Centroid#Centroid_of_polygon</span>
polygon_centroid &lt;-<span class="st"> </span>function(x0, y0) {
  x1 &lt;-<span class="st"> </span><span class="kw">c</span>(x0[-<span class="dv">1</span>], x0[<span class="dv">1</span>])
  y1 &lt;-<span class="st"> </span><span class="kw">c</span>(y0[-<span class="dv">1</span>], y0[<span class="dv">1</span>])
  A &lt;-<span class="st"> </span><span class="kw">sum</span>(x0 *<span class="st"> </span>y1 -<span class="st"> </span>x1 *<span class="st"> </span>y0) /<span class="st"> </span><span class="dv">2</span>
  Cx &lt;-<span class="st"> </span><span class="kw">sum</span>((x0 +<span class="st"> </span>x1) *<span class="st"> </span>(x0 *<span class="st"> </span>y1 -<span class="st"> </span>x1 *<span class="st"> </span>y0)) /<span class="st"> </span>(<span class="dv">6</span> *<span class="st"> </span>A)
  Cy &lt;-<span class="st"> </span><span class="kw">sum</span>((y0 +<span class="st"> </span>y1) *<span class="st"> </span>(x0 *<span class="st"> </span>y1 -<span class="st"> </span>x1 *<span class="st"> </span>y0)) /<span class="st"> </span>(<span class="dv">6</span> *<span class="st"> </span>A)
  <span class="kw">data.frame</span>(<span class="dt">long =</span> Cx, <span class="dt">lat =</span> Cy)
}

<span class="co"># Calculate geographic centroids for each county</span>
centroids &lt;-<span class="st"> </span>NM_map[, <span class="kw">polygon_centroid</span>(long, lat), by =<span class="st"> </span>.(subregion)]

<span class="co"># Plot map with labels at centroids</span>
<span class="kw">ggplot</span>() +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> NM_map,
               <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group),
               <span class="dt">color =</span> <span class="st">"white"</span>, <span class="dt">fill =</span> <span class="st">"grey"</span>) +
<span class="st">  </span><span class="kw">geom_text</span>(<span class="dt">data =</span> centroids, 
            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">label =</span> subregion)) +
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"Counties of New Mexico"</span>) +
<span class="st">  </span><span class="kw">theme_bw</span>()</code></pre></div>
<p><img src="make_data_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>Before proceeding, we will make some changes to the data to ensure that the counties are named the same across all tables. The main functions of the scanstatistic package require locations to be encoded as integers. Thus we will make the county names into a factor variable, which are integer vectors with additional attributes. All levels of the factor should also be present in the data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(magrittr)
<span class="kw">library</span>(stringr)
<span class="kw">library</span>(plyr, <span class="dt">warn.conflicts =</span> <span class="ot">FALSE</span>)

<span class="co"># This function corrects inconsistencies in the county names</span>
format_counties &lt;-<span class="st"> </span>function(x) {
  x %&gt;%
<span class="st">    </span>tolower %&gt;%
<span class="st">    </span><span class="kw">str_replace_all</span>(<span class="dt">pattern =</span> <span class="st">" "</span>, <span class="dt">replacement =</span> <span class="st">""</span>) %&gt;%
<span class="st">    </span><span class="kw">str_replace_all</span>(<span class="dt">pattern =</span> <span class="st">"&ntilde;"</span>, <span class="dt">replacement =</span> <span class="st">"n"</span>) %&gt;%
<span class="st">    </span><span class="kw">str_replace_all</span>(<span class="dt">pattern =</span> <span class="st">"guadelupe"</span>, <span class="dt">replacement =</span> <span class="st">"guadalupe"</span>)
}

<span class="co"># Make the county factor variable</span>
all_counties &lt;-<span class="st"> </span>NM_map$subregion %&gt;%
<span class="st">  </span>unique %&gt;%
<span class="st">  </span>format_counties %&gt;%
<span class="st">  </span>as.factor

<span class="co"># Character vector without Cibola county</span>
counties &lt;-<span class="st"> </span><span class="kw">levels</span>(all_counties)[-<span class="kw">which</span>(<span class="kw">levels</span>(all_counties) ==<span class="st"> "cibola"</span>)]

<span class="co"># This function corrects inconsistencies in x and makes it into a factor</span>
factorize_counties &lt;-<span class="st"> </span>function(x, <span class="dt">fac =</span> counties) {
  x %&gt;%
<span class="st">    </span>format_counties %&gt;%
<span class="st">    </span><span class="kw">factor</span>(<span class="dt">levels =</span> <span class="kw">c</span>(fac, <span class="st">"cibola"</span>))
}

<span class="co"># Fix inconsistencies and factorize counties in the data</span>
NM_cas %&lt;&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">county =</span> <span class="kw">factorize_counties</span>(county))
NM_pop %&lt;&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">county =</span> <span class="kw">factorize_counties</span>(county))
NM_map %&lt;&gt;%<span class="st"> </span><span class="kw">mutate</span>(<span class="dt">county =</span> <span class="kw">factorize_counties</span>(subregion))
NM_pop[, year :<span class="er">=</span><span class="st"> </span>year +<span class="st"> </span><span class="dv">1900</span>]</code></pre></div>
<pre><code>##           county year population agegroup sex
##    1: bernalillo 1973      15537        1   1
##    2: bernalillo 1973      14931        1   2
##    3:     catron 1973         99        1   1
##    4:     catron 1973         99        1   2
##    5:     chaves 1973       1888        1   1
##   ---                                        
## 3452:   torrance 1991         62       18   2
## 3453:      union 1991         32       18   1
## 3454:      union 1991         48       18   2
## 3455:   valencia 1991        193       18   1
## 3456:   valencia 1991        328       18   2</code></pre>
<p>Scan statistics aim to find <em>localized</em> anomalies in the data, meaning that the locations and timepoints involved in the anomaly are close together in some way. In this example, we will measure the spatial similarity using the spherical distance between the county seats. In other circumstances, we might use the geographic centroids (calculated above), or another distance measure. So let&rsquo;s grab the coordinates of the county seats from Wikipedia and plot them. Kudos to Cory Nissen for <a href="http://blog.corynissen.com/2015/01/using-rvest-to-scrape-html-table.html">this blogpost</a>, which shows how to fetch data from a table on Wikipedia.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rvest)

<span class="co"># Grab the table from Wikipedia</span>
seat_url &lt;-<span class="st"> "https://en.wikipedia.org/wiki/List_of_counties_in_New_Mexico"</span>
NM_geo &lt;-<span class="st"> </span>seat_url %&gt;%
<span class="st">  </span><span class="kw">read_html</span>() %&gt;%
<span class="st">  </span><span class="kw">html_nodes</span>(<span class="dt">xpath=</span><span class="st">'//*[@id="mw-content-text"]/table[3]'</span>) %&gt;%
<span class="st">  </span><span class="kw">html_table</span>()

NM_geo &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(NM_geo[[<span class="dv">1</span>]][<span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)])
<span class="kw">names</span>(NM_geo) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"county"</span>, <span class="st">"seat"</span>)

<span class="co"># Clean the table</span>
NM_geo %&lt;&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">county =</span> <span class="kw">sub</span>(<span class="st">" County"</span>, <span class="st">""</span>, county)) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">county =</span> <span class="kw">factorize_counties</span>(county, counties))

<span class="co"># Get the coordinates for the New Mexico county seats using ggmap::geocode</span>
get_NM_longlat &lt;-<span class="st"> </span>function(seats) {
  <span class="kw">suppressMessages</span>({
    res &lt;-<span class="st"> </span><span class="kw">t</span>(<span class="kw">sapply</span>(seats, function(x) <span class="kw">t</span>(ggmap::<span class="kw">geocode</span>(<span class="kw">paste0</span>(x, <span class="st">", New Mexico"</span>)))))
  })
  <span class="kw">data.frame</span>(<span class="dt">long =</span> res[, <span class="dv">1</span>], <span class="dt">lat =</span> res[, <span class="dv">2</span>])
}

NM_geo &lt;-<span class="st"> </span><span class="kw">cbind</span>(NM_geo, <span class="kw">get_NM_longlat</span>(NM_geo$seat))
NM_geo &lt;-<span class="st"> </span>NM_geo[-<span class="kw">which</span>(county ==<span class="st"> "cibola"</span>), ]

<span class="kw">ggplot</span>() +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_polygon</span>(<span class="dt">data =</span> NM_map,
               <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat, <span class="dt">group =</span> group),
               <span class="dt">color =</span> <span class="st">"white"</span>, <span class="dt">fill =</span> <span class="st">"grey"</span>) +
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data =</span> NM_geo, 
             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> long, <span class="dt">y =</span> lat)) +
<span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">"County seats of New Mexico"</span>) +
<span class="st">  </span><span class="kw">theme_bw</span>()</code></pre></div>
<p><img src="make_data_files/figure-html/unnamed-chunk-4-1.png" width="672"></p>
<p>For the scan statistic functions in this package to work, locations and timepoints with zero counts must be filled in as such, and not left out. Thus, we will add the needed zeros to the case data. We will only consider the total number of cancer cases in each county and year, so we also take the oppotunity to aggregate the case counts over each age group and sex:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Aggregate population and cases over sex and age group</span>
NM_cas &lt;-<span class="st"> </span>NM_cas[, .(<span class="dt">count =</span> <span class="kw">sum</span>(cases)), by =<span class="st"> </span>.(year, county)]
NM_pop &lt;-<span class="st"> </span>NM_pop[, .(<span class="dt">population =</span> <span class="kw">sum</span>(population)), by =<span class="st"> </span>.(year, county)]

<span class="co"># Create the complete, sorted table of counties, years, age groups, and sex</span>
combo_YC &lt;-<span class="st"> </span><span class="kw">as.data.table</span>(<span class="kw">expand.grid</span>(<span class="dt">year =</span> <span class="kw">unique</span>(NM_cas$year), 
                                      <span class="dt">county =</span> counties))

<span class="co"># Set keys for merge</span>
<span class="kw">setkeyv</span>(NM_cas, <span class="kw">c</span>(<span class="st">"year"</span>, <span class="st">"county"</span>))
<span class="kw">setkeyv</span>(NM_pop, <span class="kw">c</span>(<span class="st">"year"</span>, <span class="st">"county"</span>))
<span class="kw">setkeyv</span>(combo_YC, <span class="kw">c</span>(<span class="st">"year"</span>, <span class="st">"county"</span>))

<span class="co"># Merge data</span>
NM_cas &lt;-<span class="st"> </span><span class="kw">merge</span>(NM_cas, combo_YC, <span class="dt">all =</span> <span class="ot">TRUE</span>)
NM_pop &lt;-<span class="st"> </span><span class="kw">merge</span>(NM_pop, combo_YC, <span class="dt">all =</span> <span class="ot">TRUE</span>)

<span class="co"># Fill in zero case counts</span>
NM_cas[<span class="kw">is.na</span>(count), count :<span class="er">=</span><span class="st"> </span><span class="dv">0</span>]</code></pre></div>
<pre><code>##      year     county count
##   1: 1973 bernalillo    16
##   2: 1973     catron     0
##   3: 1973     chaves     2
##   4: 1973     colfax     0
##   5: 1973      curry     2
##  ---                      
## 604: 1991    socorro     1
## 605: 1991       taos     1
## 606: 1991   torrance     0
## 607: 1991      union     0
## 608: 1991   valencia     4</code></pre>
<p>To demonstrate the scan statistic methods of this package, we will try to detect brain cancer clusters in the years 1986&ndash;1989, using data from the previous years to predict how many cancer cases we can expect to see if there is no anomalous increase in incidence. In this particular example, we want to use the available population size data as offsets to our predicted means, in order to properly compare the occurence of cancer in the different counties. Since the population counts are only available for three of the years, we will interpolate the population for the remaining years by fitting a quadratic function of time to the population data for each county after aggregating the number of cancer cases over age group and gender<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a>. Though this leads to unrealistically smooth population changes, it is adequate for the purpose of demonstrating the functions in the <em>scanstatistics</em> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">NM_pop[, population :<span class="er">=</span><span class="st"> </span><span class="kw">as.numeric</span>(population)]</code></pre></div>
<pre><code>##      year     county population
##   1: 1973 bernalillo     353813
##   2: 1973     catron       2372
##   3: 1973     chaves      45204
##   4: 1973     colfax      12577
##   5: 1973      curry      42709
##  ---                           
## 604: 1991    socorro      14696
## 605: 1991       taos      23679
## 606: 1991   torrance      10658
## 607: 1991      union       4136
## 608: 1991   valencia      70135</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Interpolate county populations</span>
for (s in counties) {
  pop_mod &lt;-<span class="st"> </span><span class="kw">lm</span>(population ~<span class="st"> </span><span class="dv">1</span> +<span class="st"> </span><span class="kw">I</span>(<span class="kw">scale</span>(year)) +<span class="st"> </span><span class="kw">I</span>(<span class="kw">scale</span>(year)^<span class="dv">2</span>), 
                <span class="dt">data =</span> NM_pop[county ==<span class="st"> </span>s, ])
  pop_pred &lt;-<span class="st"> </span><span class="kw">predict</span>(pop_mod, NM_pop[<span class="kw">is.na</span>(population) &amp;<span class="st"> </span>county ==<span class="st"> </span>s, ], 
                      <span class="dt">type =</span> <span class="st">"response"</span>)
  NM_pop[<span class="kw">is.na</span>(population) &amp;<span class="st"> </span>county ==<span class="st"> </span>s, population :<span class="er">=</span><span class="st"> </span>pop_pred]
}</code></pre></div>
<p>Finally, we join the population and case tables and plot how the number of cases evolve in each county over the years:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">NM_popcas &lt;-<span class="st"> </span><span class="kw">merge</span>(NM_pop, NM_cas)
<span class="kw">setkeyv</span>(NM_popcas, <span class="kw">c</span>(<span class="st">"county"</span>, <span class="st">"year"</span>))

<span class="kw">ggplot</span>(NM_popcas) +<span class="st"> </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> count, <span class="dt">color =</span> county)) +
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"none"</span>)</code></pre></div>
<p><img src="make_data_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<p>The data tables <code>NM_popcas</code> and <code>NM_geo</code> are then saved as those available in the <em>scanstatistics</em> package.</p>
<div id="refs" class="references">
<div id="ref-datatable">
<p>Dowle, M, A Srinivasan, T Short, S Lianoglou with contributions from R Saporta, and E Antonyan. 2015. <em>Data.table: Extension of Data.frame</em>. <a href="https://CRAN.R-project.org/package=data.table" class="uri">https://CRAN.R-project.org/package=data.table</a>.</p>
</div>
<div id="ref-rsatscan">
<p>Kleinman, Ken. 2015. <em>Rsatscan: Tools, Classes, and Methods for Interfacing with Satscan Stand-Alone Software</em>. <a href="https://CRAN.R-project.org/package=rsatscan" class="uri">https://CRAN.R-project.org/package=rsatscan</a>.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr><ol><li id="fn1"><p>One could also fit the quadratic function for each county, age group and sex, and then aggregate over the latter two categories in the hope that this would cancel out the errors made in each interpolation. However, this seems to lead to some unreasonable year-to-year population changes for some of the counties.<a href="#fnref1">&#8617;</a></p></li>
</ol></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked"><li><a href="#process-the-brain-cancer-data">Process the brain cancer data</a></li>
      </ul></div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Benjamin Kjellson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer></div>

  </body></html>
